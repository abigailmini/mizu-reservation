<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mizu Staff Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #0C0A08; --card: #141210; --card-hover: #1A1714;
    --gold: #C9A96E; --gold-dim: rgba(201,169,110,0.4);
    --text: #E8E0D4; --dim: #7A7368; --border: rgba(201,169,110,0.1);
    --green: #5B8A6A; --yellow: #C9A96E; --red: #B85450; --blue: #5B7EA6;
  }
  body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-weight: 300; -webkit-font-smoothing: antialiased; }

  .header {
    padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--bg); z-index: 10;
    backdrop-filter: blur(12px);
  }
  .header .logo { font-size: 1.1rem; font-weight: 500; color: var(--gold); letter-spacing: 0.06em; }
  .header .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; margin-right: 6px; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
  .header .date-nav { display: flex; align-items: center; gap: 8px; }
  .header .date-nav button { background: none; border: 1px solid var(--border); color: var(--dim); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; transition: all 150ms; }
  .header .date-nav button:hover { border-color: var(--gold-dim); color: var(--gold); }
  .header .date-label { font-size: 0.85rem; color: var(--text); min-width: 140px; text-align: center; }
  .header .today-tag { font-size: 0.6rem; background: var(--gold); color: var(--bg); padding: 2px 6px; border-radius: 4px; font-weight: 600; letter-spacing: 0.05em; }

  .container { max-width: 720px; margin: 0 auto; padding: 16px; }

  /* Stats bar */
  .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
  .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 12px; text-align: center; }
  .stat-card .stat-val { font-size: 1.5rem; font-weight: 500; color: var(--gold); }
  .stat-card .stat-label { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }

  /* Session block */
  .session-block { margin-bottom: 24px; }
  .session-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; background: var(--card); border: 1px solid var(--border);
    border-radius: 10px 10px 0 0; cursor: pointer;
  }
  .session-header:hover { background: var(--card-hover); }
  .session-header .session-name { font-weight: 500; font-size: 0.95rem; }
  .session-header .session-time { font-size: 0.78rem; color: var(--dim); margin-left: 10px; }
  .session-header .seat-count { display: flex; align-items: center; gap: 8px; }
  .seat-bar { width: 80px; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; }
  .seat-bar .fill { height: 100%; border-radius: 3px; transition: width 300ms ease; }
  .seat-bar .fill.green { background: var(--green); }
  .seat-bar .fill.yellow { background: var(--yellow); }
  .seat-bar .fill.red { background: var(--red); }
  .seat-text { font-size: 0.75rem; color: var(--dim); white-space: nowrap; }

  .session-body { border: 1px solid var(--border); border-top: none; border-radius: 0 0 10px 10px; overflow: hidden; }

  /* Course summary */
  .course-summary { display: flex; gap: 6px; padding: 10px 16px; background: rgba(201,169,110,0.03); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
  .course-chip { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: rgba(201,169,110,0.08); color: var(--gold); border: 1px solid rgba(201,169,110,0.15); }

  /* Guest rows */
  .guest-row {
    display: grid; grid-template-columns: 36px 1fr auto;
    align-items: center; gap: 12px; padding: 12px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    transition: background 150ms ease;
  }
  .guest-row:last-child { border-bottom: none; }
  .guest-row:hover { background: rgba(255,255,255,0.015); }

  .guest-num { width: 28px; height: 28px; border-radius: 50%; background: rgba(201,169,110,0.08); border: 1px solid rgba(201,169,110,0.15); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: var(--gold); font-weight: 500; }

  .guest-info { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
  .guest-name { font-weight: 400; font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .guest-meta { font-size: 0.72rem; color: var(--dim); display: flex; gap: 10px; flex-wrap: wrap; }
  .guest-course { font-size: 0.72rem; color: var(--gold); }
  .guest-phone { font-size: 0.72rem; color: var(--dim); }

  .guest-tags { display: flex; gap: 4px; flex-shrink: 0; align-items: center; }
  .tag { font-size: 0.6rem; padding: 3px 7px; border-radius: 4px; font-weight: 500; letter-spacing: 0.03em; text-transform: uppercase; }
  .tag.allergy { background: rgba(184,84,80,0.15); color: var(--red); border: 1px solid rgba(184,84,80,0.25); }
  .tag.notes { background: rgba(91,126,166,0.12); color: var(--blue); border: 1px solid rgba(91,126,166,0.2); }
  .tag.vip { background: rgba(201,169,110,0.12); color: var(--gold); border: 1px solid rgba(201,169,110,0.2); }
  .tag.paid { background: rgba(91,138,106,0.12); color: var(--green); border: 1px solid rgba(91,138,106,0.2); }

  /* Notes tooltip */
  .notes-detail { display: none; padding: 8px 16px 12px 56px; font-size: 0.76rem; color: var(--dim); line-height: 1.5; background: rgba(255,255,255,0.01); border-bottom: 1px solid rgba(255,255,255,0.03); }
  .notes-detail.show { display: block; }

  /* Detail panel */
  .detail-panel { display:none; padding:12px 16px; background:linear-gradient(180deg, rgba(0,0,0,0.12), transparent); border:1px solid rgba(201,169,110,0.06); margin:8px 12px 18px; border-radius:10px; color:var(--text); }
  .detail-panel.show { display:block; }
  .detail-row { display:flex; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.02); }
  .detail-row .label { color:var(--dim); font-size:0.78rem; }
  .detail-row .value { color:var(--text); font-size:0.9rem; text-align:right; }
  .detail-allergy { color:var(--red); font-weight:600; }

  /* Empty state */
  .empty-session { padding: 24px 16px; text-align: center; color: var(--dim); font-size: 0.85rem; }

  /* Edit Modal */
  .modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:100; align-items:center; justify-content:center; padding:16px; }
  .modal-overlay.show { display:flex; }
  .modal { background:var(--card); border:1px solid var(--border); border-radius:14px; width:100%; max-width:440px; max-height:90vh; overflow-y:auto; padding:20px; }
  .modal h3 { color:var(--gold); font-size:1rem; font-weight:500; margin-bottom:16px; }
  .modal label { display:block; font-size:0.72rem; color:var(--dim); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:4px; margin-top:12px; }
  .modal input, .modal textarea { width:100%; background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:8px; padding:10px 12px; color:var(--text); font-family:inherit; font-size:0.85rem; outline:none; }
  .modal input:focus, .modal textarea:focus { border-color:var(--gold-dim); }
  .modal textarea { resize:vertical; min-height:60px; }
  .modal-actions { display:flex; gap:8px; margin-top:20px; flex-wrap:wrap; }
  .modal-actions button { flex:1; min-width:80px; padding:10px 12px; border-radius:8px; border:1px solid var(--border); background:none; color:var(--text); font-family:inherit; font-size:0.78rem; cursor:pointer; transition:all 150ms; font-weight:500; }
  .modal-actions button:hover { border-color:var(--gold-dim); }
  .modal-actions .btn-save { background:var(--gold); color:var(--bg); border-color:var(--gold); }
  .modal-actions .btn-save:hover { opacity:0.9; }
  .modal-actions .btn-cancel-booking { background:rgba(184,84,80,0.15); color:var(--red); border-color:rgba(184,84,80,0.3); }
  .modal-actions .btn-postpone { background:rgba(201,169,110,0.1); color:var(--gold); border-color:rgba(201,169,110,0.2); }
  .modal-actions .btn-charge { background:rgba(91,138,106,0.12); color:var(--green); border-color:rgba(91,138,106,0.2); }
  .modal-status { font-size:0.78rem; color:var(--dim); text-align:center; margin-top:12px; min-height:20px; }

  /* Refresh */
  .refresh-bar { text-align: center; padding: 12px; font-size: 0.7rem; color: var(--dim); }
  .refresh-bar button { background: none; border: 1px solid var(--border); color: var(--dim); padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-family: inherit; transition: all 150ms; }
  .refresh-bar button:hover { border-color: var(--gold-dim); color: var(--gold); }

  .loading { text-align: center; padding: 40px; color: var(--dim); }
  .loading::before { content:''; display:inline-block; width:16px; height:16px; border-radius:50%; border:2px solid rgba(201,169,110,0.15); border-top-color:var(--gold); animation:spin 800ms linear infinite; margin-right:8px; vertical-align:middle; }
  @keyframes spin { to { transform:rotate(360deg); } }

  @media (max-width: 480px) {
    .stats-bar { grid-template-columns: repeat(2, 1fr); }
    .seat-bar { width: 50px; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="logo"><span class="live-dot"></span>MIZU STAFF</div>
  <div class="date-nav">
    <button onclick="navDate(-1)">‚Äπ</button>
    <span class="date-label" id="dateLabel"></span>
    <button onclick="navDate(1)">‚Ä∫</button>
  </div>
</div>

<div class="container">
  <div class="stats-bar" id="statsBar"></div>
  <div id="content"><div class="loading">Loading reservations...</div></div>
  <div class="refresh-bar">
    <button onclick="loadData()">‚Üª Refresh</button>
    <span id="lastUpdate"></span>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h3>‚úèÔ∏è Edit Reservation</h3>
    <input type="hidden" id="editCreatedAt">
    <label>Guest Names (comma-separated)</label>
    <textarea id="editGuestNames" placeholder="John, Jane, Mike"></textarea>
    <label>Notes</label>
    <textarea id="editNotes" placeholder="Special requests, dietary needs..."></textarea>
    <label>Allergy / Dietary</label>
    <input type="text" id="editAllergy" placeholder="e.g. No shellfish, vegetarian">
    <label>Phone</label>
    <input type="text" id="editPhone">
    <label>Email</label>
    <input type="text" id="editEmail">
    <div class="modal-actions">
      <button class="btn-save" onclick="saveEdit()">üíæ Save</button>
      <button onclick="closeModal()">‚úï Close</button>
    </div>
    <div style="border-top:1px solid var(--border);margin-top:16px;padding-top:12px">
      <div style="font-size:0.72rem;color:var(--dim);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.06em">Actions</div>
      <div class="modal-actions">
        <button class="btn-postpone" onclick="doAction('postpone')">üìÖ Postpone</button>
        <button class="btn-cancel-booking" onclick="doAction('cancel')">‚ùå Cancel</button>
        <button class="btn-charge" onclick="doAction('charge')">üí≥ Charge No-Show</button>
      </div>
    </div>
    <div class="modal-status" id="editStatus"></div>
  </div>
</div>

<script>
const MIZU_GIST = 'https://gist.githubusercontent.com/abigailmini/4f8c9f567fa8a13d002fd5a2b703e8ed/raw/mizu-api-url.txt';
const FALLBACK_API = 'https://dam-attachments-inline-horizontal.trycloudflare.com';
let API_BASE = (location.hostname === 'localhost' || location.hostname.endsWith('.trycloudflare.com')) ? location.origin : FALLBACK_API;
// v2 cache bust

let _reservations = []; // Global store for edit modal

const SESSIONS = [
  { name: 'Lunch', time: '12:00 PM ‚Äî 2:00 PM', max: 20 },
  { name: 'Dinner 1', time: '6:00 PM ‚Äî 8:00 PM', max: 20 },
  { name: 'Dinner 2', time: '8:30 PM ‚Äî 10:30 PM', max: 20 }
];

let currentDate = new Date();
currentDate.setHours(0,0,0,0);

function dateStr(d) { const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function isToday(d) { const t = new Date(); t.setHours(0,0,0,0); return d.getTime() === t.getTime(); }

function navDate(dir) {
  currentDate = new Date(currentDate.getTime() + dir * 86400000);
  updateDateLabel();
  loadData();
}

function updateDateLabel() {
  const label = document.getElementById('dateLabel');
  const opts = { weekday: 'short', day: 'numeric', month: 'short' };
  const txt = currentDate.toLocaleDateString('en-MY', opts);
  label.innerHTML = isToday(currentDate) ? `<span class="today-tag">TODAY</span> ${txt}` : txt;
}

async function loadData() {
  document.getElementById('content').innerHTML = '<div class="loading">Loading...</div>';
  try {
    const [availRes, resRes] = await Promise.all([
      fetch(`${API_BASE}/availability?date=${dateStr(currentDate)}`, { headers: { 'Bypass-Tunnel-Reminder': 'true' } }),
      fetch(`${API_BASE}/staff/reservations?date=${dateStr(currentDate)}`, { headers: { 'Bypass-Tunnel-Reminder': 'true' } })
    ]);
    const avail = await availRes.json();
    const data = await resRes.json();
    render(avail, data.reservations || []); attachRowListeners();
    // defensive retry: if reservations exist but no guest rows rendered, retry once after short delay
    setTimeout(()=>{ try{ if ((data.reservations||[]).length>0 && document.querySelectorAll(".guest-row").length===0){ console.log("staff: retrying render due to missing rows"); render(avail, data.reservations || []); attachRowListeners(); } }catch(e){console.log("staff: retry failed", e.message);} }, 250);
    document.getElementById('lastUpdate').textContent = ` Updated ${new Date().toLocaleTimeString('en-MY', { hour: '2-digit', minute: '2-digit' })}`;
  } catch(e) {
    document.getElementById('content').innerHTML = `<div class="loading" style="color:#B85450">Failed to load. <a href="#" onclick="loadData();return false" style="color:var(--gold)">Retry</a></div>`;
  }
}

function render(avail, reservations) {
  _reservations = []; // Reset for fresh render

  // Stats
  const totalGuests = reservations.reduce((s, r) => s + (parseInt(r.pax) || 0), 0);
  const totalBookings = reservations.length;
  const totalSeats = SESSIONS.reduce((s, sess) => s + sess.max, 0);
  const allergyCount = reservations.filter(r => r.notes && /allerg|diet|vegetar|vegan|halal|no\s*(pork|beef|shell|nut|gluten|dairy|seafood|alcohol)/i.test(r.notes)).length;

  document.getElementById('statsBar').innerHTML = `
    <div class="stat-card"><div class="stat-val">${totalGuests}</div><div class="stat-label">Guests</div></div>
    <div class="stat-card"><div class="stat-val">${totalBookings}</div><div class="stat-label">Bookings</div></div>
    <div class="stat-card"><div class="stat-val">${totalSeats - totalGuests}</div><div class="stat-label">Seats Left</div></div>
    <div class="stat-card"><div class="stat-val">${allergyCount}</div><div class="stat-label">‚ö†Ô∏è Dietary</div></div>
  `;

  // Sessions
  let html = '';
  SESSIONS.forEach(sess => {
    const sessRes = reservations.filter(r => r.session === sess.name);
    const bookedPax = sessRes.reduce((s, r) => s + (parseInt(r.pax) || 0), 0);
    const pct = Math.round((bookedPax / sess.max) * 100);
    const fillClass = pct >= 90 ? 'red' : pct >= 50 ? 'yellow' : 'green';

    // Course counts
    const courseCounts = {};
    sessRes.forEach(r => {
      const courses = (r.course || '').split(',').map(c => c.trim()).filter(Boolean);
      courses.forEach(c => { courseCounts[c] = (courseCounts[c] || 0) + 1; });
    });

    html += `<div class="session-block">
      <div class="session-header" onclick="this.parentElement.querySelector('.session-body').classList.toggle('collapsed')">
        <div><span class="session-name">${sess.name}</span><span class="session-time">${sess.time}</span></div>
        <div class="seat-count">
          <div class="seat-bar"><div class="fill ${fillClass}" style="width:${pct}%"></div></div>
          <span class="seat-text">${bookedPax}/${sess.max}</span>
        </div>
      </div>
      <div class="session-body">`;

    if (Object.keys(courseCounts).length > 0) {
      html += `<div class="course-summary">`;
      Object.entries(courseCounts).forEach(([name, count]) => {
        html += `<span class="course-chip">${name} √ó${count}</span>`;
      });
      html += `</div>`;
    }

    // Store session reservations in global array for edit modal
    sessRes.forEach(r => { r._idx = _reservations.length; _reservations.push(r); });

    if (sessRes.length === 0) {
      html += `<div class="empty-session">No reservations yet</div>`;
    } else {
      sessRes.forEach((r, i) => {
        const hasAllergy = r.notes && /allerg|diet|vegetar|vegan|halal|no\s*(pork|beef|shell|nut|gluten|dairy|seafood|alcohol)/i.test(r.notes);
        const hasNotes = r.notes && r.notes.trim().length > 0;
        const hasPaid = r.paymentIntent && r.paymentIntent.length > 0;
        const courses = (r.course || '').split(',').map(c => c.trim()).filter(Boolean);
        const courseDisplay = courses.length <= 2
          ? courses.join(', ')
          : [...new Set(courses)].map(c => { const cnt = courses.filter(x=>x===c).length; return cnt > 1 ? `${c} √ó${cnt}` : c; }).join(', ');

        // Parse addons and guestNames if present
        let addonsHTML = '';
        try {
          const addons = r.addons ? (typeof r.addons === 'string' ? JSON.parse(r.addons) : r.addons) : {};
          const addonEntries = Object.entries(addons || {}).filter(([,v])=>v>0);
          if (addonEntries.length) addonsHTML = addonEntries.map(a=>`${a[0]} √ó${a[1]}`).join('<br>');
        } catch(e) { addonsHTML = ''; }

        let guestNamesHTML = '';
        try {
          const gnames = r.guestNames ? (typeof r.guestNames === 'string' ? JSON.parse(r.guestNames) : r.guestNames) : [];
          if (gnames && gnames.length) guestNamesHTML = gnames.map((n,idx)=>`${idx+1}. ${n}`).join('<br>');
        } catch(e) { guestNamesHTML = ''; }

        html += `<div class="guest-row" data-detail-id="detail-${sess.name.replace(/\\s/g,'')}-${i}" style="cursor:pointer">
          <div class="guest-num">${i + 1}</div>
          <div class="guest-info">
            <div class="guest-name">${r.name || 'Guest'} <span style="color:var(--dim);font-size:0.78rem">√ó${r.pax || 1}</span></div>
            <div class="guest-meta">
              <span class="guest-course">${courseDisplay || '‚Äî'}</span>
              <span class="guest-phone">${r.phone || ''}</span>
            </div>
            <div class="guest-inline-extra" style="margin-top:6px">
              <div class="guest-names-inline" style="font-size:0.72rem;color:var(--dim)">${guestNamesHTML ? guestNamesHTML.replace(/<br>/g, ', ') : ''}</div>
              ${r.allergy ? `<div style="font-size:0.72rem;color:var(--red);margin-top:4px">‚ö† ${r.allergy}</div>` : ''}
              <div class="guest-note-inline" style="font-size:0.72rem;color:var(--dim);margin-top:4px">${r.notes ? (r.notes.length>80 ? r.notes.substring(0,77)+'...' : r.notes) : ''}</div>
            </div>
          </div>
          <div class="guest-tags">
            ${r.allergy ? '<span class="tag allergy">‚ö† ALLERGY</span>' : (hasAllergy ? '<span class="tag allergy">‚ö† ALLERGY</span>' : '')}
            ${hasNotes && !hasAllergy ? '<span class="tag notes">üìù NOTE</span>' : ''}
            ${hasPaid ? '<span class="tag paid">üí≥</span>' : ''}
            <button class="tag" style="cursor:pointer;background:rgba(201,169,110,0.1);color:var(--gold);border:1px solid rgba(201,169,110,0.2)" onclick="event.stopPropagation();openEdit(${r._idx})">‚úèÔ∏è</button>
          </div>
        </div>`;

        // Detail panel (hidden) ‚Äî shows full details
        html += `<div class="detail-panel" id="detail-${sess.name.replace(/\s/g,'')}-${i}">
          <div class="detail-row"><div class="label">Booker</div><div class="value">${r.name || '‚Äî'}</div></div>
          <div class="detail-row"><div class="label">Phone</div><div class="value">${r.phone || '‚Äî'}</div></div>
          <div class="detail-row"><div class="label">Email</div><div class="value">${r.email || '‚Äî'}</div></div>
          <div class="detail-row"><div class="label">Guests</div><div class="value">${r.pax || 1}</div></div>
          <div class="detail-row"><div class="label">Courses</div><div class="value">${courseDisplay || '‚Äî'}</div></div>
          <div class="detail-row"><div class="label">Add-ons</div><div class="value">${addonsHTML || '‚Äî'}</div></div>
          <div class="detail-row"><div class="label">Guest Names</div><div class="value">${guestNamesHTML || '‚Äî'}</div></div>
          <div class="detail-row"><div class="label">Payment</div><div class="value">${r.paymentIntent ? 'Paid' : 'Unpaid'}</div></div>
          <div class="detail-row"><div class="label">Notes</div><div class="value">${r.notes ? r.notes : '‚Äî'}</div></div>
          <div style="text-align:right;margin-top:8px"><button onclick="copyEmail('${r.email}');event.stopPropagation()" style="background:none;border:1px solid var(--border);padding:6px 10px;border-radius:6px;color:var(--dim);cursor:pointer">Copy Email</button></div>
        </div>`;

        if (hasNotes) {
          html += `<div class="notes-detail" id="notes-${i}-${sess.name.replace(/\s/g,'')}">üìù ${r.notes}</div>`;
        }
      });
    }

    html += `</div></div>`;
  });

  document.getElementById('content').innerHTML = html;
  // Attach direct listeners to guest rows to ensure clicks work on mobile
  attachRowListeners();
}

function attachRowListeners() {
  document.querySelectorAll('.guest-row').forEach(row => {
    row.removeEventListener('click', row._glistener);
    const id = row.getAttribute('data-detail-id');
    const fn = function(e) { if (e.target.tagName.toLowerCase()==='button' || e.target.closest('button')) return; toggleDetail(id); }
    row._glistener = fn;
    row.addEventListener('click', fn);
  });
}


function toggleDetail(id) {
  const el = document.getElementById(id);
  if (!el) return;
  // hide other panels
  document.querySelectorAll('.detail-panel').forEach(d => { if (d.id !== id) d.classList.remove('show'); });
  el.classList.toggle('show');
}

function copyEmail(e) { if (!e) return; navigator.clipboard && navigator.clipboard.writeText(e); alert('Email copied: ' + e); }

// Init
(async () => {
  if (location.hostname.endsWith('.github.io')) {
    try {
      const r = await fetch(MIZU_GIST + '?t=' + Date.now());
      const url = (await r.text()).trim();
      if (url.startsWith('https://')) API_BASE = url;
    } catch(e) {}
  }
  updateDateLabel();
  loadData();
  // Auto-refresh every 60s
  setInterval(loadData, 60000);

// Event delegation for guest row clicks (replaces inline onclick handlers)
document.getElementById('content').addEventListener('click', function(e){
  const row = e.target.closest('.guest-row');
  if (!row) return;
  const id = row.getAttribute('data-detail-id');
  if (!id) return;
  // If the click was on a button inside the row, ignore
  if (e.target.tagName.toLowerCase() === 'button' || e.target.closest('button')) return;
  toggleDetail(id);
});

})();

// ‚îÄ‚îÄ Edit Modal Functions ‚îÄ‚îÄ
function openEdit(idx) {
  const r = _reservations[idx];
  if (!r) return;
  document.getElementById('editCreatedAt').value = r.createdAt || '';
  document.getElementById('editGuestNames').value = r.guestNames || '';
  document.getElementById('editNotes').value = r.notes || '';
  document.getElementById('editAllergy').value = r.allergy || '';
  document.getElementById('editPhone').value = r.phone || '';
  document.getElementById('editEmail').value = r.email || '';
  document.getElementById('editStatus').textContent = '';
  document.getElementById('editModal').classList.add('show');
}

function closeModal() {
  document.getElementById('editModal').classList.remove('show');
}

async function saveEdit() {
  const status = document.getElementById('editStatus');
  status.textContent = 'Saving...';
  status.style.color = 'var(--gold)';
  const payload = {
    createdAt: document.getElementById('editCreatedAt').value,
    guestNames: document.getElementById('editGuestNames').value,
    notes: document.getElementById('editNotes').value,
    allergy: document.getElementById('editAllergy').value,
    phone: document.getElementById('editPhone').value,
    email: document.getElementById('editEmail').value
  };
  try {
    const r = await fetch(`${API_BASE}/staff/update`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' },
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if (data.success) {
      status.textContent = '‚úÖ Saved!';
      status.style.color = 'var(--green)';
      setTimeout(() => { closeModal(); loadData(); }, 800);
    } else {
      status.textContent = '‚ùå ' + (data.error || 'Failed');
      status.style.color = 'var(--red)';
    }
  } catch(e) {
    status.textContent = '‚ùå Network error';
    status.style.color = 'var(--red)';
  }
}

async function doAction(act) {
  const createdAt = document.getElementById('editCreatedAt').value;
  if (!createdAt) return;
  const labels = { cancel: 'Cancel this booking?', postpone: 'Postpone this booking?', charge: 'Charge no-show fee?' };
  if (!confirm(labels[act] || `Perform ${act}?`)) return;
  const status = document.getElementById('editStatus');
  status.textContent = 'Processing...';
  status.style.color = 'var(--gold)';
  try {
    const r = await fetch(`${API_BASE}/staff/action`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' },
      body: JSON.stringify({ createdAt, action: act })
    });
    const data = await r.json();
    if (data.success) {
      status.textContent = `‚úÖ ${act.charAt(0).toUpperCase() + act.slice(1)} done!`;
      status.style.color = 'var(--green)';
      setTimeout(() => { closeModal(); loadData(); }, 800);
    } else {
      status.textContent = '‚ùå ' + (data.error || 'Failed');
      status.style.color = 'var(--red)';
    }
  } catch(e) {
    status.textContent = '‚ùå Network error';
    status.style.color = 'var(--red)';
  }
}

// Close modal on overlay click
document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>