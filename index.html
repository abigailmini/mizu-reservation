<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mizu Omakase — Reservation</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=Inter:wght@300;400;500&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --gold: #B58F55; /* muted aged gold */
    --gold-light: #D7B67E;
    --bg: #0e0f10; /* dark charcoal */
    --bg-card: #121315;
    --bg-hover: #161618;
    --text: #E8E8E8;
    --text-dim: #9a9a9a;
    --border: rgba(255,255,255,0.04);
    --success: #4A7A5A;
    --error: #8A3A3A;
    --glass: rgba(255,255,255,0.02);
  }

  body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-weight: 300;
    -webkit-font-smoothing: antialiased;
    background-image: radial-gradient(rgba(255,255,255,0.01) 1px, transparent 1px), linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
    background-size: 10px 10px, 100% 100%;
  }

  .container {
    max-width: 480px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* subtle wave divider */
  .wave {
    width: 100%; max-width: 240px; margin: 18px auto 0; opacity:0.6;
  }

  /* ── Landing ── */
  .landing {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 24px;
    padding-top: 40px;
    transition: opacity 300ms ease, transform 300ms ease;
  }

  .logo-section h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 3.2rem;
    font-weight: 300;
    color: var(--gold);
    letter-spacing: 0.15em;
    line-height: 1.1;
    text-transform: uppercase;
  }

  .logo-section .subtitle {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    color: var(--text-dim);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-top: 6px;
  }

  .logo-section .tagline {
    margin-top: 10px; color: #cfc6b8; font-size: 0.95rem; opacity:0.95; font-weight:300; letter-spacing:0.02em;
  }

  .logo-section .divider {
    width: 60px;
    height: 1px;
    background: linear-gradient(90deg, rgba(181,143,85,0.9), rgba(181,143,85,0.2));
    margin: 14px auto;
    opacity: 0.9;
  }

  .logo-section .address {
    font-size: 0.8rem;
    color: var(--text-dim);
    line-height: 1.6;
  }

  /* buttons */
  .btn {
    display: block;
    width: 100%;
    padding: 12px 28px;
    border: 1px solid rgba(181,143,85,0.9);
    background: transparent;
    color: var(--gold);
    font-family: 'Inter', sans-serif;
    font-size: 0.85rem;
    font-weight: 400;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 220ms ease;
    text-align: center;
    text-decoration: none;
    border-radius: 8px;
    backdrop-filter: blur(6px);
  }

  .btn.primary { background: transparent; color: var(--gold); padding: 10px 26px; border-width:1px; }
  .btn.primary:hover { background: rgba(181,143,85,0.06); color: var(--gold-light); transform: translateY(-2px); box-shadow: 0 6px 18px rgba(11,11,11,0.5); }
  .btn:hover { opacity:0.95; }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; transform:none; }

  .landing-buttons { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 12px; }

  /* ── Steps ── */
  .step { display: none; flex-direction: column; gap: 20px; padding-top: 20px; opacity:0; transform:translateY(6px); transition: opacity 260ms ease, transform 260ms ease; }
  .step.active { display: flex; opacity:1; transform:none; }

  .step-header { display: flex; align-items: center; gap: 12px; }

  .back-btn { background: none; border: none; color: var(--text-dim); font-size: 1.2rem; cursor: pointer; padding: 6px 8px; }

  .step-title { font-family: 'Cormorant Garamond', serif; font-size: 1.25rem; color: var(--gold); font-weight: 400; }

  /* ── Date Picker ── */
  .date-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 8px 2px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .date-scroll::-webkit-scrollbar { display: none; }

  .date-item {
    flex-shrink: 0;
    width: 68px;
    padding: 12px 10px;
    border: 1px solid var(--border);
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: transform 180ms ease, border-color 180ms ease, background 180ms ease;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  .date-item:hover { transform: translateY(-4px); border-color: rgba(181,143,85,0.9); }
  .date-item.selected { border-color: rgba(181,143,85,0.95); background: linear-gradient(180deg, rgba(181,143,85,0.06), rgba(0,0,0,0.0)); }
  .date-item.blocked { opacity: 0.32; cursor: not-allowed; }

  .date-item .day-name { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
  .date-item .day-num { font-size: 1.3rem; margin: 6px 0; color: var(--text); font-weight: 400; }
  .date-item .month { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; }
  .date-item.selected .day-num { color: var(--gold); }

  /* ── Party Size (circle) ── */
  .pax-selector { display: flex; gap: 8px; flex-wrap: wrap; }

  .pax-item {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    border-radius: 50%;
    cursor: pointer;
    transition: transform 160ms ease, background 160ms ease, box-shadow 160ms ease;
    font-size: 0.95rem;
    background: var(--bg-card);
    box-shadow: inset 0 -2px 6px rgba(0,0,0,0.6);
  }

  .pax-item:hover { transform: translateY(-3px); border-color: rgba(181,143,85,0.9); }
  .pax-item.selected { border-color: rgba(181,143,85,0.95); background: linear-gradient(180deg, rgba(181,143,85,0.06), rgba(0,0,0,0)); color: var(--gold); box-shadow: 0 8px 20px rgba(11,11,11,0.6); }

  /* ── Sessions ── */
  .session-list { display: flex; flex-direction: column; gap: 12px; }

  .session-card {
    padding: 14px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: transform 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden;
  }

  .session-card::after {
    content: '';
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
    width: 26px; height: 26px; border-radius: 50%; border: 1px solid rgba(181,143,85,0.12); box-shadow: inset 0 0 8px rgba(181,143,85,0.02);
  }

  .session-card:hover:not(.full) { border-color: rgba(181,143,85,0.95); transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
  .session-card.selected { border-color: rgba(181,143,85,0.95); background: rgba(181,143,85,0.04); }
  .session-card.full { opacity: 0.46; }

  .session-info h3 { font-family: 'Cormorant Garamond', serif; font-size: 1.05rem; font-weight: 400; margin-bottom: 4px; }
  .session-info .time { font-size: 0.8rem; color: var(--text-dim); }
  .session-meta { text-align: right; }
  .session-meta .price { color: var(--gold); font-size: 0.9rem; }
  .session-meta .seats { font-size: 0.75rem; color: var(--text-dim); margin-top: 4px; }
  .session-meta .seats.low { color: #C97A4E; }
  .session-meta .waitlist-tag { font-size: 0.68rem; color: var(--error); border: 1px solid var(--error); padding: 4px 8px; border-radius: 6px; }

  /* ── Course selection: compact chips (course cards are created with .session-card in JS; restyle within #courseList) ── */
  #courseList .session-card { display: inline-flex; padding: 8px 12px; border-radius: 999px; margin-right: 8px; margin-bottom: 8px; align-items: center; gap:12px; }
  #courseList .session-card .session-info h3 { font-size: 0.9rem; }
  #courseList .session-card .session-meta { text-align: right; min-width:54px; }

  /* when JS renders a vertical options container, make it wrap nicely */
  #courseList { display:flex; flex-direction:column; gap:12px; }
  #courseList div[style] { /* rows created by JS */ display:block; }

  /* Make the chips look tactile */
  #courseList .session-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
  #courseList .session-card.selected { background: linear-gradient(90deg, rgba(181,143,85,0.07), rgba(0,0,0,0.02)); color: var(--gold); border-color: rgba(181,143,85,0.9); }

  /* ── Form (refined inputs) ── */
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group label { font-size: 0.72rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.12em; }

  .form-group input, .form-group textarea {
    background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 14px;
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-size: 0.95rem;
    font-weight: 300;
    outline: none;
    transition: border-color 0.18s ease, box-shadow 0.18s ease;
  }

  .form-group input:focus, .form-group textarea:focus { border-color: rgba(181,143,85,0.95); box-shadow: 0 8px 24px rgba(11,11,11,0.6); }
  .form-group textarea { resize: vertical; min-height: 88px; }

  /* floating-placeholder hint (use placeholder text lightly) */
  .form-group input::placeholder, .form-group textarea::placeholder { color: rgba(255,255,255,0.22); }

  /* ── Confirmation ── */
  .confirmation { text-align: center; padding: 30px 0; animation: fadeIn 420ms ease both; }
  @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform:none; } }

  .confirmation .check {
    width: 70px; height: 70px; border: 2px solid var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 18px; font-size: 1.6rem; color: var(--gold);
    box-shadow: 0 12px 36px rgba(11,11,11,0.6);
  }

  .confirmation h2 { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; color: var(--gold); font-weight: 400; margin-bottom: 6px; }
  .confirmation .status-msg { color: var(--text-dim); margin-bottom: 18px; font-size: 0.95rem; }

  .booking-summary { background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: left; margin-bottom: 18px; }
  .booking-summary .row { display:flex; justify-content:space-between; padding:8px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
  .booking-summary .row:last-child { border: none; }
  .booking-summary .row .label { color: var(--text-dim); }

  .loading { text-align: center; padding: 28px; color: var(--text-dim); position:relative; }
  .loading:before { content:''; display:inline-block; width:18px; height:18px; border-radius:50%; border:3px solid rgba(181,143,85,0.15); border-top-color: var(--gold); animation: spin 900ms linear infinite; margin-right:10px; vertical-align:middle; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg { color: #C97A4E; font-size: 0.9rem; text-align: center; padding: 8px; }

  .section-label { font-size: 0.72rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.12em; }

  /* small screens adjustments */
  @media (max-width:480px) {
    .container { padding: 18px; }
    .logo-section h1 { font-size: 3rem; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- Landing -->
  <div class="landing" id="landing">
    <div class="logo-section">
      <h1>MIZU</h1>
      <div class="subtitle">Omakase</div>
      <div class="tagline">An intimate dining experience — seasonal, small-batch, crafted</div>
      <div class="divider"></div>
      <svg class="wave" viewBox="0 0 120 20" xmlns="http://www.w3.org/2000/svg"><path d="M0 10 C 20 2, 40 18, 60 10 C 80 2,100 18,120 10" stroke="rgba(181,143,85,0.6)" stroke-width="0.9" fill="none" stroke-linecap="round"/></svg>
      <div class="address">
        53-G, Block D, Jaya One<br>
        Petaling Jaya, Selangor
      </div>
    </div>
    <div class="landing-buttons">
      <button class="btn primary" onclick="startReservation()">Make a Reservation</button>
      <a class="btn" href="tel:+60129130952">Call Us</a>
    </div>
  </div>

  <!-- Step 1: Date -->
  <div class="step" id="step1">
    <div class="step-header">
      <button class="back-btn" onclick="goLanding()">←</button>
      <span class="step-title">Select Date</span>
    </div>

    <div class="date-scroll" id="dateScroll"></div>

    <button class="btn primary" id="step1Next" disabled onclick="goStep2()">Continue</button>
  </div>

  <!-- Step 2: Session (time) -->
  <div class="step" id="step2">
    <div class="step-header">
      <button class="back-btn" onclick="goStep1()">←</button>
      <span class="step-title">Select Session</span>
    </div>
    <div id="sessionsLoading" class="loading">Loading availability...</div>
    <div class="session-list" id="sessionList"></div>
    <div id="sessionError" class="error-msg" style="display:none"></div>
    <button class="btn primary" id="step2Next" disabled onclick="goStep2b()">Continue</button>
  </div>

  <!-- Step 2b: Party Size + Course -->
  <div class="step" id="step2b">
    <div class="step-header">
      <button class="back-btn" onclick="goStep2()">←</button>
      <span class="step-title">Party Size & Menu</span>
    </div>

    <div class="section-label">Party Size</div>
    <div class="pax-selector" id="paxSelector"></div>

    <div id="courseSection" style="display:none">
      <div class="section-label" style="margin-top:20px">Select Course for Each Guest</div>
      <div id="courseList"></div>
    </div>

    <button class="btn primary" id="step2bNext" disabled onclick="goStep3()">Continue</button>
  </div>

  <!-- Step 3: Details -->
  <div class="step" id="step3">
    <div class="step-header">
      <button class="back-btn" onclick="goStep2b()">←</button>
      <span class="step-title">Your Details</span>
    </div>

    <div class="form-group">
      <label>Name *</label>
      <input type="text" id="guestName" placeholder="Full name" required>
    </div>
    <div class="form-group">
      <label>Phone *</label>
      <input type="tel" id="guestPhone" placeholder="+60 12 345 6789" required>
    </div>
    <div class="form-group">
      <label>Email *</label>
      <input type="email" id="guestEmail" placeholder="your@email.com" required>
    </div>
    <div class="form-group">
      <label>Special Requests</label>
      <textarea id="guestNotes" placeholder="Allergies, celebrations, dietary requirements..."></textarea>
    </div>

    <div id="formError" class="error-msg" style="display:none"></div>
    <button class="btn primary" id="submitBtn" onclick="submitReservation()">Confirm Reservation</button>
  </div>

  <!-- Step 4: Confirmation -->
  <div class="step" id="step4">
    <div class="confirmation" id="confirmationContent"></div>
    <button class="btn" onclick="goLanding()">Done</button>
  </div>

</div>

<script>
const MIZU_GIST = 'https://gist.githubusercontent.com/abigailmini/4f8c9f567fa8a13d002fd5a2b703e8ed/raw/mizu-api-url.txt';
const FALLBACK_API = 'https://9538cb73ceb40a2e-60-50-218-160.serveousercontent.com';
let API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.endsWith('.serveousercontent.com')) ? `${window.location.origin}` : FALLBACK_API;

// State
let selectedDate = null;
let selectedPax = null;
let selectedSession = null;
let selectedCourse = null; // will be array like ["Mirin Course", "Kirin Course", "Mirin Course"]
let guestCourses = []; // per-guest selections
let availableCourses = [];
let availabilityData = null;
let blockedDates = [];
let isWaitlist = false;

// Try to load tunnel URL
async function loadApiUrl() {
  try {
    const urlFile = '/tmp/mizu-api-url.txt';
    // For GitHub Pages, we'll try the gist approach or use a hardcoded URL
    // For local dev, localhost works
  } catch (e) {}
}

// ── Navigation ──

function showStep(id) {
  document.querySelectorAll('.step, .landing').forEach(el => el.classList.remove('active'));
  const el = document.getElementById(id);
  if (id === 'landing') { el.style.display = 'flex'; }
  else { el.classList.add('active'); document.getElementById('landing').style.display = 'none'; }
}

function goLanding() {
  selectedDate = null; selectedPax = null; selectedSession = null; selectedCourse = null;
  document.getElementById('landing').style.display = 'flex';
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
}

function startReservation() { showStep('step1'); initDatePicker(); }
function goStep1() { showStep('step1'); }
function goStep2() { showStep('step2'); loadAvailability(); }
function goStep2b() { showStep('step2b'); initPaxSelector(); loadCourses(); updateStep2bBtn(); }
function goStep3() { showStep('step3'); }

// ── Date Picker ──

function initDatePicker() {
  const container = document.getElementById('dateScroll');
  container.innerHTML = '';
  const today = new Date();
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  for (let i = 1; i <= 30; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() + i);
    const dateStr = d.toISOString().split('T')[0];
    const blocked = blockedDates.includes(dateStr);

    const item = document.createElement('div');
    item.className = 'date-item' + (blocked ? ' blocked' : '');
    item.innerHTML = `
      <div class="day-name">${days[d.getDay()]}</div>
      <div class="day-num">${d.getDate()}</div>
      <div class="month">${months[d.getMonth()]}</div>
    `;
    if (!blocked) {
      item.onclick = () => {
        document.querySelectorAll('.date-item').forEach(el => el.classList.remove('selected'));
        item.classList.add('selected');
        selectedDate = dateStr;
        checkStep1();
      };
    }
    container.appendChild(item);
  }
}

// ── Pax Selector ──

function initPaxSelector() {
  const container = document.getElementById('paxSelector');
  container.innerHTML = '';
  for (let i = 1; i <= 10; i++) {
    const item = document.createElement('div');
    item.className = 'pax-item';
    item.textContent = i;
    item.onclick = () => {
      document.querySelectorAll('.pax-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
      selectedPax = i;
      renderGuestCourses();
      updateStep2bBtn();
    };
    container.appendChild(item);
  }
}

function checkStep1() {
  document.getElementById('step1Next').disabled = !selectedDate;
}

function updateStep2bBtn() {
  const allPicked = selectedPax && guestCourses.length === selectedPax && guestCourses.every(x => x);
  document.getElementById('step2bNext').disabled = !allPicked;
  if (allPicked) selectedCourse = guestCourses.join(', ');
}

// ── Availability ──

async function loadAvailability() {
  const list = document.getElementById('sessionList');
  const loading = document.getElementById('sessionsLoading');
  const error = document.getElementById('sessionError');
  list.innerHTML = '';
  loading.style.display = 'block';
  error.style.display = 'none';
  document.getElementById('step2Next').disabled = true;
  selectedSession = null;

  try {
    const res = await fetch(`${API_BASE}/availability?date=${selectedDate}`, {
      headers: { 'Bypass-Tunnel-Reminder': 'true' }
    });
    availabilityData = await res.json();
    loading.style.display = 'none';

    if (availabilityData.blocked) {
      error.textContent = `Closed: ${availabilityData.reason}`;
      error.style.display = 'block';
      return;
    }

    availableCourses = availabilityData.courses || [];
    availabilityData.sessions.forEach(s => {
      const isFull = s.remaining <= 0;
      const card = document.createElement('div');
      card.className = 'session-card' + (isFull ? ' full' : '');

      card.innerHTML = `
        <div class="session-info">
          <h3>${s.name}</h3>
          <div class="time">${formatTime(s.startTime)} — ${formatTime(s.endTime)}</div>
        </div>
        <div class="session-meta">
          ${isFull ? '<div class="waitlist-tag">Fully Booked</div>' : ''}
        </div>
      `;

      card.onclick = () => {
        document.querySelectorAll('.session-card').forEach(el => el.classList.remove('selected'));
        card.classList.add('selected');
        selectedSession = s;
        isWaitlist = isFull;
        document.getElementById('step2Next').disabled = false;
        document.getElementById('step2Next').textContent = isFull ? 'Join Waitlist' : 'Continue';
      };

      list.appendChild(card);
    });
  } catch (e) {
    loading.style.display = 'none';
    error.innerHTML = 'Unable to load availability. <a href="#" onclick="loadAvailability();return false" style="color:var(--gold)">Tap to retry</a>';
    error.style.display = 'block';
  }
}

function loadCourses() { renderGuestCourses(); }

function renderGuestCourses() {
  const section = document.getElementById('courseSection');
  const list = document.getElementById('courseList');
  list.innerHTML = '';
  guestCourses = [];
  selectedCourse = null;

  if (!selectedPax || !availableCourses.length) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  guestCourses = new Array(selectedPax).fill(null);

  for (let g = 0; g < selectedPax; g++) {
    const row = document.createElement('div');
    row.style.cssText = 'margin-bottom:16px';

    const label = document.createElement('div');
    label.style.cssText = 'color:var(--text-dim);font-size:0.8rem;letter-spacing:0.05em;margin-bottom:8px';
    label.textContent = selectedPax === 1 ? 'YOUR COURSE' : `GUEST ${g + 1}`;
    row.appendChild(label);

    const options = document.createElement('div');
    options.style.cssText = 'display:flex;flex-direction:column;gap:8px';

    availableCourses.forEach(c => {
      const btn = document.createElement('div');
      btn.className = 'session-card';
      btn.setAttribute('data-guest', g);
      btn.setAttribute('data-course', c.name);
      btn.innerHTML = `
        <div class="session-info"><h3 style="font-size:0.9rem">${c.name}</h3></div>
        <div class="session-meta"><span class="price">RM ${c.price}</span></div>
      `;
      btn.onclick = () => {
        options.querySelectorAll('.session-card').forEach(el => el.classList.remove('selected'));
        btn.classList.add('selected');
        guestCourses[g] = c.name;
        // Update selectedCourse as comma-separated string for the API
        if (guestCourses.every(x => x)) {
          selectedCourse = guestCourses.join(', ');
        }
        updateStep2bBtn();
      };
      options.appendChild(btn);
    });

    row.appendChild(options);
    list.appendChild(row);
  }
}

function formatTime(t) {
  const [h, m] = t.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const h12 = h % 12 || 12;
  return `${h12}:${m.toString().padStart(2,'0')} ${ampm}`;
}

// ── Submit ──

async function submitReservation() {
  const name = document.getElementById('guestName').value.trim();
  const phone = document.getElementById('guestPhone').value.trim();
  const email = document.getElementById('guestEmail').value.trim();
  const notes = document.getElementById('guestNotes').value.trim();
  const error = document.getElementById('formError');
  error.style.display = 'none';

  if (!name || !phone || !email) {
    error.textContent = 'Please fill in all required fields.';
    error.style.display = 'block';
    return;
  }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.textContent = 'Submitting...';

  try {
    const endpoint = isWaitlist ? '/waitlist' : '/reserve';
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' },
      body: JSON.stringify({
        date: selectedDate,
        session: selectedSession.name,
        course: selectedCourse,
        name, phone, email,
        pax: selectedPax,
        notes
      })
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error);

    showConfirmation(data, name, phone, email);
  } catch (e) {
    error.textContent = e.message || 'Something went wrong. Please try again.';
    error.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Confirm Reservation';
  }
}

function showConfirmation(data, name, phone, email) {
  const isWL = data.status === 'waitlist';
  const content = document.getElementById('confirmationContent');
  content.innerHTML = `
    <div class="check">${isWL ? '⏳' : '✓'}</div>
    <h2>${isWL ? 'Waitlisted' : 'Reservation Confirmed'}</h2>
    <p class="status-msg">${isWL
      ? 'You\'re on the waitlist. We\'ll contact you if a spot opens up.'
      : 'Thank you! We look forward to welcoming you.'
    }</p>
    <div class="booking-summary">
      <div class="row"><span class="label">Date</span><span>${formatDisplayDate(selectedDate)}</span></div>
      <div class="row"><span class="label">Session</span><span>${selectedSession.name} (${formatTime(selectedSession.startTime)})</span></div>
      <div class="row"><span class="label">Party Size</span><span>${selectedPax} ${selectedPax === 1 ? 'guest' : 'guests'}</span></div>
      <div class="row"><span class="label">Name</span><span>${name}</span></div>
      ${guestCourses.length ? `<div class="row"><span class="label">Menu</span><span>${guestCourses.length === 1 ? guestCourses[0] : guestCourses.map((c,i) => `G${i+1}: ${c}`).join('<br>')}</span></div>` : ''}
      ${!isWL && guestCourses.length ? `<div class="row"><span class="label">Total</span><span>RM ${guestCourses.reduce((sum, c) => sum + ((availableCourses.find(x=>x.name===c)||{}).price||0), 0)}</span></div>` : ''}
    </div>
  `;
  showStep('step4');
}

function formatDisplayDate(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

// ── Init ──
let stripe = null;
let stripeElements = null;
let cardElement = null;
(async function init() {
  // Auto-discover API URL from gist (if on GitHub Pages)
  if (window.location.hostname.endsWith('.github.io')) {
    try {
      const r = await fetch(MIZU_GIST + '?t=' + Date.now());
      const url = (await r.text()).trim();
      if (url.startsWith('https://')) API_BASE = url;
    } catch(e) { console.log('Gist fetch failed, using fallback'); }
  }
  console.log('API_BASE:', API_BASE);

  // Load config to get blocked dates
  try {
    const res = await fetch(`${API_BASE}/config`, { headers: { 'Bypass-Tunnel-Reminder': 'true' } });
    const config = await res.json();
    blockedDates = (config.blocked || []).map(b => b['Blocked Date']);
  } catch(e) { console.log('Config load failed, using defaults'); }

  // Check if Stripe is configured on the server and load Stripe.js if so
  try {
    const r = await fetch(`${API_BASE}/stripe-key`, {headers:{'Bypass-Tunnel-Reminder':'true'}});
    const info = await r.json();
    if (info.publishableKey) {
      const s = document.createElement('script');
      s.src = 'https://js.stripe.com/v3/';
      document.head.appendChild(s);
      s.onload = () => {
        stripe = Stripe(info.publishableKey);
      };
    }
  } catch(e) { console.log('Stripe key load failed'); }
})();

// Modify submitReservation to support Stripe Elements when available
async function submitReservation() {
  const name = document.getElementById('guestName').value.trim();
  const phone = document.getElementById('guestPhone').value.trim();
  const email = document.getElementById('guestEmail').value.trim();
  const notes = document.getElementById('guestNotes').value.trim();
  const error = document.getElementById('formError');
  error.style.display = 'none';

  if (!name || !phone || !email) {
    error.textContent = 'Please fill in all required fields.';
    error.style.display = 'block';
    return;
  }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.textContent = 'Submitting...';

  try {
    const endpoint = isWaitlist ? '/waitlist' : '/book';

    const payload = {
      date: selectedDate,
      session: selectedSession.name,
      course: selectedCourse,
      name, phone, email,
      pax: selectedPax,
      notes
    };

    // If Stripe is available and this is a confirmed booking (not waitlist), collect card
    if (stripe && !isWaitlist) {
      // Create payment method using Stripe Elements or fallback to Stripe Payment Request
      // For brevity: use stripe.createPaymentMethod with a card element if present
      if (!cardElement) {
        // create a simple mounted card element in a prompt-like flow
        const container = document.createElement('div');
        container.style.position = 'fixed';
        container.style.left = '0';
        container.style.right = '0';
        container.style.top = '0';
        container.style.bottom = '0';
        container.style.background = 'rgba(0,0,0,0.6)';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.innerHTML = `
          <div style="width:320px;background:#0A0A0A;padding:16px;border-radius:8px;">
            <div style="color:#E8E8E8;margin-bottom:8px">Card details (RM100 hold)</div>
            <div id="card-placeholder" style="background:#141414;padding:12px;border-radius:6px;border:1px solid #2A2A2A"></div>
            <div style="display:flex;gap:8px;margin-top:12px;">
              <button id="cardCancel" class="btn">Cancel</button>
              <button id="cardPay" class="btn primary">Authorize RM100</button>
            </div>
          </div>
        `;
        document.body.appendChild(container);
        stripeElements = stripe.elements();
        cardElement = stripeElements.create('card', { style: { base: { color: '#E8E8E8', '::placeholder': { color: '#888' } } } });
        cardElement.mount('#card-placeholder');
        document.getElementById('cardCancel').onclick = () => { container.remove(); btn.disabled = false; btn.textContent = 'Confirm Reservation'; };
        document.getElementById('cardPay').onclick = async () => {
          document.getElementById('cardPay').disabled = true; document.getElementById('cardPay').textContent = 'Authorizing...';
          const pmResult = await stripe.createPaymentMethod({ type: 'card', card: cardElement, billing_details: { name, email, phone } });
          if (pmResult.error) {
            error.textContent = pmResult.error.message; error.style.display = 'block'; btn.disabled = false; btn.textContent = 'Confirm Reservation'; container.remove(); return;
          }
          payload.createHold = true;
          payload.payment_method = pmResult.paymentMethod.id;

          try {
            const res = await fetch(`${API_BASE}${endpoint}`, {
              method: 'POST', headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' }, body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            container.remove(); showConfirmation(data, name, phone, email);
          } catch (e) {
            error.textContent = e.message || 'Payment failed'; error.style.display = 'block';
          }
        };
        return;
      }
    }

    // Fallback: no stripe or waitlist
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error);

    showConfirmation(data, name, phone, email);
  } catch (e) {
    error.textContent = e.message || 'Something went wrong. Please try again.';
    error.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Confirm Reservation';
  }
}
</script>
</body>
</html>