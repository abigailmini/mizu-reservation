<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mizu Omakase — Reservation</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=Inter:wght@300;400;500&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --gold: #C9A96E;
    --gold-light: #DFC08A;
    --bg: #0A0A0A;
    --bg-card: #141414;
    --bg-hover: #1A1A1A;
    --text: #E8E8E8;
    --text-dim: #888;
    --border: #2A2A2A;
    --success: #4A7A5A;
    --error: #8A3A3A;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-weight: 300;
    -webkit-font-smoothing: antialiased;
  }

  .container {
    max-width: 480px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ── Landing ── */
  .landing {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 40px;
  }

  .logo-section h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 3.2rem;
    font-weight: 300;
    color: var(--gold);
    letter-spacing: 0.15em;
    line-height: 1.1;
  }

  .logo-section .subtitle {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    color: var(--text-dim);
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin-top: 8px;
  }

  .logo-section .divider {
    width: 60px;
    height: 1px;
    background: var(--gold);
    margin: 20px auto;
    opacity: 0.5;
  }

  .logo-section .address {
    font-size: 0.8rem;
    color: var(--text-dim);
    line-height: 1.6;
  }

  .btn {
    display: block;
    width: 100%;
    padding: 16px 32px;
    border: 1px solid var(--gold);
    background: transparent;
    color: var(--gold);
    font-family: 'Inter', sans-serif;
    font-size: 0.85rem;
    font-weight: 400;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    text-decoration: none;
  }

  .btn:hover { background: var(--gold); color: var(--bg); }
  .btn.primary { background: var(--gold); color: var(--bg); }
  .btn.primary:hover { background: var(--gold-light); }
  .btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .landing-buttons { width: 100%; max-width: 300px; display: flex; flex-direction: column; gap: 12px; }

  /* ── Steps ── */
  .step { display: none; flex-direction: column; gap: 24px; padding-top: 20px; }
  .step.active { display: flex; }

  .step-header {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .back-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 4px 8px;
  }

  .step-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    color: var(--gold);
    font-weight: 400;
  }

  /* ── Date Picker ── */
  .date-scroll {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 4px 0;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .date-scroll::-webkit-scrollbar { display: none; }

  .date-item {
    flex-shrink: 0;
    width: 64px;
    padding: 12px 8px;
    border: 1px solid var(--border);
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-card);
  }

  .date-item:hover { border-color: var(--gold); }
  .date-item.selected { border-color: var(--gold); background: rgba(201,169,110,0.1); }
  .date-item.blocked { opacity: 0.3; cursor: not-allowed; }

  .date-item .day-name { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
  .date-item .day-num { font-size: 1.3rem; margin: 4px 0; color: var(--text); font-weight: 400; }
  .date-item .month { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; }
  .date-item.selected .day-num { color: var(--gold); }

  /* ── Party Size ── */
  .pax-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .pax-item {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
    background: var(--bg-card);
  }

  .pax-item:hover { border-color: var(--gold); }
  .pax-item.selected { border-color: var(--gold); background: rgba(201,169,110,0.1); color: var(--gold); }

  /* ── Sessions ── */
  .session-list { display: flex; flex-direction: column; gap: 10px; }

  .session-card {
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-card);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .session-card:hover:not(.full) { border-color: var(--gold); }
  .session-card.selected { border-color: var(--gold); background: rgba(201,169,110,0.1); }
  .session-card.full { opacity: 0.5; }

  .session-info h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.1rem;
    font-weight: 400;
    margin-bottom: 4px;
  }

  .session-info .time { font-size: 0.8rem; color: var(--text-dim); }

  .session-meta { text-align: right; }
  .session-meta .price { color: var(--gold); font-size: 0.9rem; }
  .session-meta .seats { font-size: 0.75rem; color: var(--text-dim); margin-top: 4px; }
  .session-meta .seats.low { color: #C97A4E; }
  .session-meta .waitlist-tag { font-size: 0.7rem; color: var(--error); border: 1px solid var(--error); padding: 2px 8px; border-radius: 4px; }

  /* ── Form ── */
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }

  .form-group input, .form-group textarea {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px 14px;
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-size: 0.9rem;
    font-weight: 300;
    outline: none;
    transition: border-color 0.2s;
  }

  .form-group input:focus, .form-group textarea:focus { border-color: var(--gold); }
  .form-group textarea { resize: vertical; min-height: 80px; }

  /* ── Confirmation ── */
  .confirmation {
    text-align: center;
    padding: 40px 0;
  }

  .confirmation .check {
    width: 60px;
    height: 60px;
    border: 2px solid var(--gold);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    font-size: 1.5rem;
    color: var(--gold);
  }

  .confirmation h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.8rem;
    color: var(--gold);
    font-weight: 400;
    margin-bottom: 8px;
  }

  .confirmation .status-msg { color: var(--text-dim); margin-bottom: 24px; font-size: 0.9rem; }

  .booking-summary {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    text-align: left;
    margin-bottom: 24px;
  }

  .booking-summary .row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
  }

  .booking-summary .row:last-child { border: none; }
  .booking-summary .row .label { color: var(--text-dim); }

  .loading { text-align: center; padding: 40px; color: var(--text-dim); }

  .error-msg { color: #C97A4E; font-size: 0.85rem; text-align: center; padding: 8px; }

  .section-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }
</style>
</head>
<body>
<div class="container">

  <!-- Landing -->
  <div class="landing" id="landing">
    <div class="logo-section">
      <h1>MIZU</h1>
      <div class="subtitle">Omakase</div>
      <div class="divider"></div>
      <div class="address">
        53-G, Block D, Jaya One<br>
        Petaling Jaya, Selangor
      </div>
    </div>
    <div class="landing-buttons">
      <button class="btn primary" onclick="startReservation()">Make a Reservation</button>
      <a class="btn" href="tel:+60129130952">Call Us</a>
    </div>
  </div>

  <!-- Step 1: Date & Pax -->
  <div class="step" id="step1">
    <div class="step-header">
      <button class="back-btn" onclick="goLanding()">←</button>
      <span class="step-title">Select Date & Party Size</span>
    </div>

    <div class="section-label">Date</div>
    <div class="date-scroll" id="dateScroll"></div>

    <div class="section-label">Party Size</div>
    <div class="pax-selector" id="paxSelector"></div>

    <button class="btn primary" id="step1Next" disabled onclick="goStep2()">Continue</button>
  </div>

  <!-- Step 2: Session -->
  <div class="step" id="step2">
    <div class="step-header">
      <button class="back-btn" onclick="goStep1()">←</button>
      <span class="step-title">Select Session</span>
    </div>
    <div id="sessionsLoading" class="loading">Loading availability...</div>
    <div class="session-list" id="sessionList"></div>
    <div id="sessionError" class="error-msg" style="display:none"></div>
    <button class="btn primary" id="step2Next" disabled onclick="goStep2b()">Continue</button>
  </div>

  <!-- Step 2b: Course Selection -->
  <div class="step" id="step2b">
    <div class="step-header">
      <button class="back-btn" onclick="goStep2()">←</button>
      <span class="step-title">Select Course</span>
    </div>
    <div class="session-list" id="courseList"></div>
    <button class="btn primary" id="step2bNext" disabled onclick="goStep3()">Continue</button>
  </div>

  <!-- Step 3: Details -->
  <div class="step" id="step3">
    <div class="step-header">
      <button class="back-btn" onclick="goStep2b()">←</button>
      <span class="step-title">Your Details</span>
    </div>

    <div class="form-group">
      <label>Name *</label>
      <input type="text" id="guestName" placeholder="Full name" required>
    </div>
    <div class="form-group">
      <label>Phone *</label>
      <input type="tel" id="guestPhone" placeholder="+60 12 345 6789" required>
    </div>
    <div class="form-group">
      <label>Email *</label>
      <input type="email" id="guestEmail" placeholder="your@email.com" required>
    </div>
    <div class="form-group">
      <label>Special Requests</label>
      <textarea id="guestNotes" placeholder="Allergies, celebrations, dietary requirements..."></textarea>
    </div>

    <div id="formError" class="error-msg" style="display:none"></div>
    <button class="btn primary" id="submitBtn" onclick="submitReservation()">Confirm Reservation</button>
  </div>

  <!-- Step 4: Confirmation -->
  <div class="step" id="step4">
    <div class="confirmation" id="confirmationContent"></div>
    <button class="btn" onclick="goLanding()">Done</button>
  </div>

</div>

<script>
const MIZU_GIST = 'https://gist.githubusercontent.com/abigailmini/4f8c9f567fa8a13d002fd5a2b703e8ed/raw/mizu-api-url.txt';
const FALLBACK_API = 'https://9538cb73ceb40a2e-60-50-218-160.serveousercontent.com';
let API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.endsWith('.serveousercontent.com')) ? `${window.location.origin}` : FALLBACK_API;

// State
let selectedDate = null;
let selectedPax = null;
let selectedSession = null;
let selectedCourse = null;
let availableCourses = [];
let availabilityData = null;
let blockedDates = [];
let isWaitlist = false;

// Try to load tunnel URL
async function loadApiUrl() {
  try {
    const urlFile = '/tmp/mizu-api-url.txt';
    // For GitHub Pages, we'll try the gist approach or use a hardcoded URL
    // For local dev, localhost works
  } catch (e) {}
}

// ── Navigation ──

function showStep(id) {
  document.querySelectorAll('.step, .landing').forEach(el => el.classList.remove('active'));
  const el = document.getElementById(id);
  if (id === 'landing') { el.style.display = 'flex'; }
  else { el.classList.add('active'); document.getElementById('landing').style.display = 'none'; }
}

function goLanding() {
  selectedDate = null; selectedPax = null; selectedSession = null; selectedCourse = null;
  document.getElementById('landing').style.display = 'flex';
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
}

function startReservation() { showStep('step1'); initDatePicker(); initPaxSelector(); }
function goStep1() { showStep('step1'); }
function goStep2() { showStep('step2'); loadAvailability(); }
function goStep2b() { showStep('step2b'); loadCourses(); }
function goStep3() { showStep('step3'); }

// ── Date Picker ──

function initDatePicker() {
  const container = document.getElementById('dateScroll');
  container.innerHTML = '';
  const today = new Date();
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  for (let i = 1; i <= 30; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() + i);
    const dateStr = d.toISOString().split('T')[0];
    const blocked = blockedDates.includes(dateStr);

    const item = document.createElement('div');
    item.className = 'date-item' + (blocked ? ' blocked' : '');
    item.innerHTML = `
      <div class="day-name">${days[d.getDay()]}</div>
      <div class="day-num">${d.getDate()}</div>
      <div class="month">${months[d.getMonth()]}</div>
    `;
    if (!blocked) {
      item.onclick = () => {
        document.querySelectorAll('.date-item').forEach(el => el.classList.remove('selected'));
        item.classList.add('selected');
        selectedDate = dateStr;
        checkStep1();
      };
    }
    container.appendChild(item);
  }
}

// ── Pax Selector ──

function initPaxSelector() {
  const container = document.getElementById('paxSelector');
  container.innerHTML = '';
  for (let i = 1; i <= 10; i++) {
    const item = document.createElement('div');
    item.className = 'pax-item';
    item.textContent = i;
    item.onclick = () => {
      document.querySelectorAll('.pax-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
      selectedPax = i;
      checkStep1();
    };
    container.appendChild(item);
  }
}

function checkStep1() {
  document.getElementById('step1Next').disabled = !(selectedDate && selectedPax);
}

// ── Availability ──

async function loadAvailability() {
  const list = document.getElementById('sessionList');
  const loading = document.getElementById('sessionsLoading');
  const error = document.getElementById('sessionError');
  list.innerHTML = '';
  loading.style.display = 'block';
  error.style.display = 'none';
  document.getElementById('step2Next').disabled = true;
  selectedSession = null;

  try {
    const res = await fetch(`${API_BASE}/availability?date=${selectedDate}`, {
      headers: { 'Bypass-Tunnel-Reminder': 'true' }
    });
    availabilityData = await res.json();
    loading.style.display = 'none';

    if (availabilityData.blocked) {
      error.textContent = `Closed: ${availabilityData.reason}`;
      error.style.display = 'block';
      return;
    }

    availableCourses = availabilityData.courses || [];
    availabilityData.sessions.forEach(s => {
      const isFull = s.remaining < selectedPax;
      const card = document.createElement('div');
      card.className = 'session-card' + (isFull ? ' full' : '');

      const seatsClass = s.remaining <= 5 ? 'seats low' : 'seats';

      card.innerHTML = `
        <div class="session-info">
          <h3>${s.name}</h3>
          <div class="time">${formatTime(s.startTime)} — ${formatTime(s.endTime)}</div>
        </div>
        <div class="session-meta">
          ${s.price ? `<div class="price">RM ${s.price}</div>` : ''}
          ${isFull
            ? '<div class="waitlist-tag">Join Waitlist</div>'
            : `<div class="${seatsClass}">${s.remaining} seats left</div>`
          }
        </div>
      `;

      card.onclick = () => {
        document.querySelectorAll('.session-card').forEach(el => el.classList.remove('selected'));
        card.classList.add('selected');
        selectedSession = s;
        isWaitlist = isFull;
        document.getElementById('step2Next').disabled = false;
        document.getElementById('step2Next').textContent = isFull ? 'Join Waitlist' : 'Continue';
      };

      list.appendChild(card);
    });
  } catch (e) {
    loading.style.display = 'none';
    error.innerHTML = 'Unable to load availability. <a href="#" onclick="loadAvailability();return false" style="color:var(--gold)">Tap to retry</a>';
    error.style.display = 'block';
  }
}

function loadCourses() {
  const list = document.getElementById('courseList');
  list.innerHTML = '';
  selectedCourse = null;
  document.getElementById('step2bNext').disabled = true;

  // Use courses from the last availability response
  if (!availableCourses.length) {
    list.innerHTML = '<div class="error-msg">No courses available</div>';
    return;
  }

  availableCourses.forEach(c => {
    const card = document.createElement('div');
    card.className = 'session-card';
    card.innerHTML = `
      <div class="session-info"><h3>${c.name}</h3></div>
      <div class="session-meta"><span class="price">RM ${c.price}</span><div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px">per person</div></div>
    `;
    card.onclick = () => {
      list.querySelectorAll('.session-card').forEach(el => el.classList.remove('selected'));
      card.classList.add('selected');
      selectedCourse = c.name;
      document.getElementById('step2bNext').disabled = false;
    };
    list.appendChild(card);
  });
}

function formatTime(t) {
  const [h, m] = t.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const h12 = h % 12 || 12;
  return `${h12}:${m.toString().padStart(2,'0')} ${ampm}`;
}

// ── Submit ──

async function submitReservation() {
  const name = document.getElementById('guestName').value.trim();
  const phone = document.getElementById('guestPhone').value.trim();
  const email = document.getElementById('guestEmail').value.trim();
  const notes = document.getElementById('guestNotes').value.trim();
  const error = document.getElementById('formError');
  error.style.display = 'none';

  if (!name || !phone || !email) {
    error.textContent = 'Please fill in all required fields.';
    error.style.display = 'block';
    return;
  }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.textContent = 'Submitting...';

  try {
    const endpoint = isWaitlist ? '/waitlist' : '/reserve';
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' },
      body: JSON.stringify({
        date: selectedDate,
        session: selectedSession.name,
        course: selectedCourse,
        name, phone, email,
        pax: selectedPax,
        notes
      })
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error);

    showConfirmation(data, name, phone, email);
  } catch (e) {
    error.textContent = e.message || 'Something went wrong. Please try again.';
    error.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Confirm Reservation';
  }
}

function showConfirmation(data, name, phone, email) {
  const isWL = data.status === 'waitlist';
  const content = document.getElementById('confirmationContent');
  content.innerHTML = `
    <div class="check">${isWL ? '⏳' : '✓'}</div>
    <h2>${isWL ? 'Waitlisted' : 'Reservation Confirmed'}</h2>
    <p class="status-msg">${isWL
      ? 'You\'re on the waitlist. We\'ll contact you if a spot opens up.'
      : 'Thank you! We look forward to welcoming you.'
    }</p>
    <div class="booking-summary">
      <div class="row"><span class="label">Date</span><span>${formatDisplayDate(selectedDate)}</span></div>
      <div class="row"><span class="label">Session</span><span>${selectedSession.name} (${formatTime(selectedSession.startTime)})</span></div>
      <div class="row"><span class="label">Party Size</span><span>${selectedPax} ${selectedPax === 1 ? 'guest' : 'guests'}</span></div>
      <div class="row"><span class="label">Name</span><span>${name}</span></div>
      ${selectedCourse ? `<div class="row"><span class="label">Course</span><span>${selectedCourse}</span></div>` : ''}
      ${!isWL && selectedCourse ? `<div class="row"><span class="label">Price</span><span>RM ${(availableCourses.find(c=>c.name===selectedCourse)||{}).price || 0} /pax</span></div>` : ''}
    </div>
  `;
  showStep('step4');
}

function formatDisplayDate(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

// ── Init ──
let stripe = null;
let stripeElements = null;
let cardElement = null;
(async function init() {
  // Auto-discover API URL from gist (if on GitHub Pages)
  if (window.location.hostname.endsWith('.github.io')) {
    try {
      const r = await fetch(MIZU_GIST + '?t=' + Date.now());
      const url = (await r.text()).trim();
      if (url.startsWith('https://')) API_BASE = url;
    } catch(e) { console.log('Gist fetch failed, using fallback'); }
  }
  console.log('API_BASE:', API_BASE);

  // Load config to get blocked dates
  try {
    const res = await fetch(`${API_BASE}/config`, { headers: { 'Bypass-Tunnel-Reminder': 'true' } });
    const config = await res.json();
    blockedDates = (config.blocked || []).map(b => b['Blocked Date']);
  } catch(e) { console.log('Config load failed, using defaults'); }

  // Check if Stripe is configured on the server and load Stripe.js if so
  try {
    const r = await fetch(`${API_BASE}/stripe-key`, {headers:{'Bypass-Tunnel-Reminder':'true'}});
    const info = await r.json();
    if (info.publishableKey) {
      const s = document.createElement('script');
      s.src = 'https://js.stripe.com/v3/';
      document.head.appendChild(s);
      s.onload = () => {
        stripe = Stripe(info.publishableKey);
      };
    }
  } catch(e) { console.log('Stripe key load failed'); }
})();

// Modify submitReservation to support Stripe Elements when available
async function submitReservation() {
  const name = document.getElementById('guestName').value.trim();
  const phone = document.getElementById('guestPhone').value.trim();
  const email = document.getElementById('guestEmail').value.trim();
  const notes = document.getElementById('guestNotes').value.trim();
  const error = document.getElementById('formError');
  error.style.display = 'none';

  if (!name || !phone || !email) {
    error.textContent = 'Please fill in all required fields.';
    error.style.display = 'block';
    return;
  }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.textContent = 'Submitting...';

  try {
    const endpoint = isWaitlist ? '/waitlist' : '/book';

    const payload = {
      date: selectedDate,
      session: selectedSession.name,
      course: selectedCourse,
      name, phone, email,
      pax: selectedPax,
      notes
    };

    // If Stripe is available and this is a confirmed booking (not waitlist), collect card
    if (stripe && !isWaitlist) {
      // Create payment method using Stripe Elements or fallback to Stripe Payment Request
      // For brevity: use stripe.createPaymentMethod with a card element if present
      if (!cardElement) {
        // create a simple mounted card element in a prompt-like flow
        const container = document.createElement('div');
        container.style.position = 'fixed';
        container.style.left = '0';
        container.style.right = '0';
        container.style.top = '0';
        container.style.bottom = '0';
        container.style.background = 'rgba(0,0,0,0.6)';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.innerHTML = `
          <div style="width:320px;background:#0A0A0A;padding:16px;border-radius:8px;">
            <div style="color:#E8E8E8;margin-bottom:8px">Card details (RM100 hold)</div>
            <div id="card-placeholder" style="background:#141414;padding:12px;border-radius:6px;border:1px solid #2A2A2A"></div>
            <div style="display:flex;gap:8px;margin-top:12px;">
              <button id="cardCancel" class="btn">Cancel</button>
              <button id="cardPay" class="btn primary">Authorize RM100</button>
            </div>
          </div>
        `;
        document.body.appendChild(container);
        stripeElements = stripe.elements();
        cardElement = stripeElements.create('card', { style: { base: { color: '#E8E8E8', '::placeholder': { color: '#888' } } } });
        cardElement.mount('#card-placeholder');
        document.getElementById('cardCancel').onclick = () => { container.remove(); btn.disabled = false; btn.textContent = 'Confirm Reservation'; };
        document.getElementById('cardPay').onclick = async () => {
          document.getElementById('cardPay').disabled = true; document.getElementById('cardPay').textContent = 'Authorizing...';
          const pmResult = await stripe.createPaymentMethod({ type: 'card', card: cardElement, billing_details: { name, email, phone } });
          if (pmResult.error) {
            error.textContent = pmResult.error.message; error.style.display = 'block'; btn.disabled = false; btn.textContent = 'Confirm Reservation'; container.remove(); return;
          }
          payload.createHold = true;
          payload.payment_method = pmResult.paymentMethod.id;

          try {
            const res = await fetch(`${API_BASE}${endpoint}`, {
              method: 'POST', headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' }, body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            container.remove(); showConfirmation(data, name, phone, email);
          } catch (e) {
            error.textContent = e.message || 'Payment failed'; error.style.display = 'block';
          }
        };
        return;
      }
    }

    // Fallback: no stripe or waitlist
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error);

    showConfirmation(data, name, phone, email);
  } catch (e) {
    error.textContent = e.message || 'Something went wrong. Please try again.';
    error.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Confirm Reservation';
  }
}
</script>
</body>
</html>
